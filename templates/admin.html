<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI 프로파일러 - 관리자 페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .card { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background: linear-gradient(145deg, #0e7490, #164e63); }
        .progress-bar-container { background-color: #1f2937; }
        .progress-bar-fill { background: linear-gradient(90deg, #0891b2, #22d3ee); }
    </style>
</head>
<body class="bg-gray-900 text-white bg-cover bg-fixed" style="background-image: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2070&auto=format&fit=crop');">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative min-h-screen container mx-auto p-4 md:p-8">
        <h1 class="text-4xl font-orbitron text-cyan-400 text-center mb-10">Admin Dashboard</h1>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Left Column -->
            <div class="space-y-8">
                <!-- Access Code Generator -->
                <div class="card rounded-2xl p-6">
                    <h2 class="text-2xl font-bold text-cyan-300 mb-4">접근 코드 관리</h2>
                    <button id="generate-code-btn" class="w-full btn-primary font-bold py-3 rounded-lg mb-4">새 코드 생성</button>
                    <div id="new-code-display" class="text-center h-8"></div>
                    <div class="mt-4 border-t border-gray-700 pt-4">
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">생성된 코드 목록</h3>
                        <div id="code-list" class="max-h-60 overflow-y-auto bg-black/20 p-3 rounded-md"></div>
                    </div>
                </div>

                <!-- AI Direct Question Generator -->
                <div class="card rounded-2xl p-6">
                    <h2 class="text-2xl font-bold text-cyan-300 mb-4">AI 문제 생성기 (직접)</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="ai-age-group" class="block mb-2 text-sm font-medium text-gray-300">대상 연령</label>
                            <select id="ai-age-group" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5">
                                <option>10-13</option><option>14-16</option><option>17-19</option>
                            </select>
                        </div>
                        <div>
                            <label for="ai-category" class="block mb-2 text-sm font-medium text-gray-300">측정 능력 (문제 유형)</label>
                            <select id="ai-category" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5">
                                <option value="title">제목 찾기</option>
                                <option value="theme">주제 찾기</option>
                                <option value="argument">주장 파악</option>
                                <option value="inference">의미 추론</option>
                                <option value="pronoun">지시어 찾기</option>
                                <option value="sentence_ordering">문장 순서 맞추기</option>
                                <option value="paragraph_ordering">단락 순서 맞추기</option>
                            </select>
                        </div>
                        <button id="ai-generate-btn" class="w-full btn-primary font-bold py-3 rounded-lg">AI에게 문제 생성 요청</button>
                    </div>
                    <div id="ai-status" class="text-center h-12 mt-4"></div>
                    <div id="ai-progress-container" class="w-full progress-bar-container rounded-full h-2.5 mt-2 hidden">
                        <div id="ai-progress-bar" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="card rounded-2xl p-6">
                <h2 class="text-2xl font-bold text-cyan-300 mb-4">AI 문제 생성기 (텍스트 기반)</h2>
                <div class="space-y-4">
                     <div>
                        <label for="text-age-group" class="block mb-2 text-sm font-medium text-gray-300">대상 연령</label>
                        <select id="text-age-group" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5">
                            <option>10-13</option><option>14-16</option><option>17-19</option>
                        </select>
                    </div>
                    <div>
                        <label for="text-category" class="block mb-2 text-sm font-medium text-gray-300">측정 능력 (문제 유형)</label>
                        <select id="text-category" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5">
                            <option value="title">제목 찾기</option>
                            <option value="theme">주제 찾기</option>
                            <option value="argument">주장 파악</option>
                            <option value="inference">의미 추론</option>
                            <option value="pronoun">지시어 찾기</option>
                        </select>
                    </div>
                    <div>
                        <label for="text-input" class="block mb-2 text-sm font-medium text-gray-300">분석할 텍스트 붙여넣기</label>
                        <textarea id="text-input" rows="8" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5" placeholder="기사, 블로그 포스트 등 문제로 만들고 싶은 글의 본문을 여기에 붙여넣으세요..."></textarea>
                    </div>
                    <button id="text-generate-btn" class="w-full btn-primary font-bold py-3 rounded-lg">붙여넣은 텍스트로 문제 생성</button>
                </div>
                <div id="text-status" class="text-center h-12 mt-4"></div>
                <div id="text-progress-container" class="w-full progress-bar-container rounded-full h-2.5 mt-2 hidden">
                    <div id="text-progress-bar" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- Code Management ---
    const generateCodeBtn = document.getElementById('generate-code-btn');
    const newCodeDisplay = document.getElementById('new-code-display');
    const codeList = document.getElementById('code-list');

    const fetchCodes = async () => {
        const response = await fetch('/api/get-codes');
        const codes = await response.json();
        codeList.innerHTML = codes.map(c => `
            <div class="flex justify-between items-center text-sm p-1.5 rounded ${c.isUsed ? 'text-gray-500' : 'text-gray-200'}">
                <span>${c.code}</span>
                <span class="text-xs">${c.isUsed ? `(사용됨: ${c.userName || ''})` : '(미사용)'}</span>
            </div>
        `).join('');
    };

    generateCodeBtn.addEventListener('click', async () => {
        newCodeDisplay.textContent = '생성 중...';
        const response = await fetch('/api/generate-code', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            newCodeDisplay.innerHTML = `
                <span class="text-green-400 font-mono text-lg">${data.code}</span>
                <button onclick="copyToClipboard('${data.code}')" class="ml-2 bg-gray-600 px-2 py-1 rounded text-xs hover:bg-gray-500">복사</button>
            `;
            fetchCodes();
        } else {
            newCodeDisplay.textContent = `오류: ${data.message}`;
        }
    });

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            const originalText = newCodeDisplay.innerHTML;
            newCodeDisplay.querySelector('button').textContent = '복사됨!';
            setTimeout(() => { newCodeDisplay.innerHTML = originalText; }, 2000);
        });
    }

    // --- AI Question Generation ---
    function setupAIGenerator(type) {
        const generateBtn = document.getElementById(`${type}-generate-btn`);
        const statusEl = document.getElementById(`${type}-status`);
        const progressContainer = document.getElementById(`${type}-progress-container`);
        const progressBar = document.getElementById(`${type}-progress-bar`);

        generateBtn.addEventListener('click', async () => {
            statusEl.textContent = 'AI가 문제를 생성하고 있습니다... (최대 1분 소요)';
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = `${Math.min(progress, 90)}%`;
            }, 2000);

            const ageGroup = document.getElementById(`${type}-age-group`).value;
            const category = document.getElementById(`${type}-category`).value;
            const textInput = (type === 'text') ? document.getElementById('text-input').value : null;

            const endpoint = (type === 'text') ? '/api/generate-question-from-text' : '/api/generate-question';
            const body = (type === 'text') ? 
                { text: textInput, ageGroup: ageGroup, category: category } : 
                { ageGroup: ageGroup, category: category };

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                clearInterval(interval);
                progressBar.style.width = '100%';
                
                if (data.success) {
                    statusEl.innerHTML = `<span class="text-green-400">✅ ${data.message}</span>`;
                    if (type === 'text') document.getElementById('text-input').value = ''; // Clear textarea on success
                } else {
                    statusEl.innerHTML = `<span class="text-red-400">❌ 실패: ${data.message}</span>`;
                }
            } catch (error) {
                clearInterval(interval);
                progressBar.style.width = '100%';
                statusEl.innerHTML = `<span class="text-red-400">❌ 네트워크 오류: 서버와 통신할 수 없습니다.</span>`;
            }

            setTimeout(() => {
                progressContainer.classList.add('hidden');
            }, 3000);
        });
    }

    // --- Initial Load ---
    fetchCodes();
    setupAIGenerator('ai');
    setupAIGenerator('text');
    </script>
</body>
</html>
