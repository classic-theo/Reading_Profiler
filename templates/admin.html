<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Profiler 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .card { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-5">Reading Profiler 관리 시스템</h1>

        <div class="card">
            <div class="card-header">
                <h3>접근 코드 관리</h3>
            </div>
            <div class="card-body">
                <button id="generateCodeBtn" class="btn btn-success">새 코드 생성</button>
                <table class="table mt-3">
                    <thead>
                        <tr><th>코드</th><th>생성일</th><th>사용 여부</th><th>사용자</th></tr>
                    </thead>
                    <tbody id="codesTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>문제 생성 도구</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>1. 생성 조건 설정</h5>
                        <div class="mb-3">
                            <label for="ageGroupSelect" class="form-label">대상 연령</label>
                            <select id="ageGroupSelect" class="form-select">
                                <option value="10-13">초등 (10-13세)</option>
                                <option value="14-16" selected>중등 (14-16세)</option>
                                <option value="17-19">고등 (17-19세)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="readingVolume" class="form-label">월 평균 독서량 (페이지)</label>
                            <input type="number" id="readingVolume" class="form-control" placeholder="예: 500">
                        </div>
                        <button id="analyzeDifficultyBtn" class="btn btn-secondary">난이도 분석</button>
                        <p id="difficultyResult" class="mt-2 text-primary fw-bold"></p>
                    </div>
                    <div class="col-md-6">
                        <h5>2. 텍스트 기반 생성 (선택)</h5>
                        <textarea id="textContentInput" class="form-control" rows="6" placeholder="여기에 텍스트를 붙여넣으면 해당 내용 기반으로 문제가 생성됩니다. (비워두면 AI가 주제를 자유롭게 선정)"></textarea>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <button id="generateSetBtn" class="btn btn-primary btn-lg">7개 유형 한번에 생성하기</button>
                </div>
                <div id="generationResult" class="mt-4"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>문제 은행 관리</h3>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" id="searchInput" class="form-control" placeholder="질문이나 지문 내용으로 검색...">
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="deleteSelectedBtn" class="btn btn-danger">선택 항목 삭제</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>유형</th>
                                <th>연령</th>
                                <th>난이도</th>
                                <th>질문</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="questionsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 전역 변수 ---
        let allQuestions = [];
        let analyzedDifficulty = '표준';

        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchCodes();
            fetchQuestions();
        });

        // --- 접근 코드 관리 ---
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        const codesTableBody = document.getElementById('codesTableBody');

        async function fetchCodes() {
            const response = await fetch('/api/get-codes');
            const codes = await response.json();
            codesTableBody.innerHTML = '';
            codes.forEach(c => {
                codesTableBody.innerHTML += `
                    <tr>
                        <td><strong>${c.code}</strong></td>
                        <td>${c.createdAt}</td>
                        <td>${c.isUsed ? '사용됨' : '미사용'}</td>
                        <td>${c.userName || ''}</td>
                    </tr>
                `;
            });
        }
        generateCodeBtn.addEventListener('click', async () => {
            const response = await fetch('/api/generate-code', { method: 'POST' });
            if (response.ok) fetchCodes();
        });

        // --- 문제 생성 ---
        const analyzeDifficultyBtn = document.getElementById('analyzeDifficultyBtn');
        const difficultyResult = document.getElementById('difficultyResult');
        const generateSetBtn = document.getElementById('generateSetBtn');
        const generationResult = document.getElementById('generationResult');

        analyzeDifficultyBtn.addEventListener('click', () => {
            const volume = parseInt(document.getElementById('readingVolume').value);
            if (isNaN(volume) || volume <= 0) {
                analyzedDifficulty = '표준';
                difficultyResult.textContent = '유효한 독서량을 입력해주세요. (기본 난이도: 표준)';
                return;
            }
            if (volume < 300) {
                analyzedDifficulty = '기초';
                difficultyResult.textContent = `분석 결과: 기초 난이도를 추천합니다. (쉬운 어휘, 짧은 문장)`;
            } else if (volume >= 300 && volume <= 800) {
                analyzedDifficulty = '표준';
                difficultyResult.textContent = `분석 결과: 표준 난이도를 추천합니다. (표준 어휘, 일반적 문장 구조)`;
            } else {
                analyzedDifficulty = '심화';
                difficultyResult.textContent = `분석 결과: 심화 난이도를 추천합니다. (전문/추상적 어휘, 복잡한 문장)`;
            }
        });

        generateSetBtn.addEventListener('click', async () => {
            const ageGroup = document.getElementById('ageGroupSelect').value;
            const textContent = document.getElementById('textContentInput').value;
            
            generationResult.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>문제 생성 중... (최대 2~3분 소요될 수 있습니다)</p>';

            const payload = {
                ageGroup: ageGroup,
                difficulty: analyzedDifficulty
            };
            if (textContent.trim() !== '') {
                payload.textContent = textContent;
            }

            const response = await fetch('/api/generate-question-set', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            let resultHTML = `<h5>${result.message}</h5><ul class="list-group">`;
            result.results.forEach(res => {
                const statusClass = res.status === '성공' ? 'list-group-item-success' : 'list-group-item-danger';
                resultHTML += `<li class="list-group-item ${statusClass}">${res.category}: ${res.status} ${res.status === '실패' ? `(${res.reason})` : ''}</li>`;
            });
            resultHTML += `</ul>`;
            generationResult.innerHTML = resultHTML;

            if (result.success) {
                fetchQuestions();
            }
        });

        // --- 문제 은행 관리 ---
        const searchInput = document.getElementById('searchInput');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const questionsTableBody = document.getElementById('questionsTableBody');

        async function fetchQuestions() {
            const response = await fetch('/api/get-questions');
            allQuestions = await response.json();
            renderQuestions(allQuestions);
        }

        function renderQuestions(questions) {
            questionsTableBody.innerHTML = '';
            const categoryMap = {"title":"제목 찾기","theme":"주제 찾기","argument":"주장 파악","inference":"의미 추론","pronoun":"지시어 찾기","sentence_ordering":"문장 순서 맞추기","paragraph_ordering":"단락 순서 맞추기","essay":"창의적 서술력"};
            questions.forEach(q => {
                const row = `
                    <tr>
                        <td><input type="checkbox" class="question-checkbox" data-id="${q.id}"></td>
                        <td>${categoryMap[q.category] || q.category}</td>
                        <td>${q.targetAge}</td>
                        <td>${q.difficulty || '표준'}</td>
                        <td>${q.question.substring(0, 50)}...</td>
                        <td><button class="btn btn-sm btn-info" onclick="regenerateQuestion('${q.id}')">다시 생성</button></td>
                    </tr>
                `;
                questionsTableBody.innerHTML += row;
            });
        }

        searchInput.addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) {
                renderQuestions(allQuestions);
                return;
            }
            const filteredQuestions = allQuestions.filter(q => 
                (q.question && q.question.toLowerCase().includes(searchTerm)) || 
                (q.passage && q.passage.toLowerCase().includes(searchTerm))
            );
            renderQuestions(filteredQuestions);
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.question-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const selectedIds = Array.from(document.querySelectorAll('.question-checkbox:checked')).map(cb => cb.dataset.id);

            if (selectedIds.length === 0) {
                alert('삭제할 문제를 선택해주세요.');
                return;
            }

            if (confirm(`정말로 ${selectedIds.length}개의 문제를 삭제하시겠습니까?`)) {
                const response = await fetch('/api/delete-questions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ids: selectedIds })
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    fetchQuestions();
                }
            }
        });

        async function regenerateQuestion(questionId) {
            if (!confirm('이 문제를 새로운 내용으로 다시 생성하시겠습니까?')) return;

            const response = await fetch('/api/regenerate-question', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: questionId })
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                fetchQuestions();
            }
        }
    </script>
</body>
</html>